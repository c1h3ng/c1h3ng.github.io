---
layout: post
title: "内网学习笔记——搭建域环境"
date: 2017-11-26
tags:
  内网
  web
categories:
  Web
---
~~苦于一时半会找不到实际目标来熟悉内网，所以只好自己动手搭建一个环境玩玩了，_(:з」∠)_~~
# 0x01 一些基本概念
## 域
域(Domain)即为windows网络中的逻辑组织单元，将网络中多台计算机组织到一起，进行集中管理，这种区别于工作组的逻辑环境叫做域。与工作组相比，工作组中的计算机各自为政，独占自身的资源;一个账户只能登陆一台计算机，账户的用户名密码存在本机的数据库中;各自的策略由各自设定并只在本机生效，工作组中的计算机没有等级之分。所以一旦网络规模达到一定程度，工作组的管理方式就变得非常麻烦，不再适合，因此有了能在固定范围内实现"中央集权"的管理环境——域。
## 域控
在域中，包含域的账户，密码，域内计算机构成的数据库，可统一管理域内主机的网络资源的一台计算机，这台计算机被称为域控服务器(Domain Controller | DC)，因此域环境中，每个成员的帐号密码不是像工作组一样存在本机的数据库中，而是像"中央集权"的形式一样，统一存储于DC的数据库中，并且用户登陆时也由DC验证，经过验证的用户能够访问该网络内的共享资源，这样能有效的隔离不同网络环境，保护内部网络资源。
## 域树
树即具有**连续**的域名空间的多个域，树中的域层次越深级别越低，一个"."则代表一个层次，树中的域通过信任关系连接，这些域共享同一表结构和配置，形成一个连续的域名空间，重点是连续的，这种结构关系就好比中央(DC)实施中央集权，地方上的县城就是一个一个的"域"，**指定范围内** 的县城构成一个市，也就是树。

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/domain-tree.png?raw=true)

如图，a.com及其下的子域及其子域的子域所构成的域树。
## 域林
林由**一个或多个**域树组成，一个或多个，所以林是可以只包含一个树，就类似与直辖市，既是市，行政级别上又和省厅同级，一般林会由多个树组成，类似于一个省份下面有多个市，以上举的例子可能不是很贴切，不过大概上就是这个意思。

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/domain.png?raw=true)

如图为三个不同的域，它们组成一个域林。
## 林根域
根域就是第一个被创建的域，可知林根域就是域林中第一个被创建的域，如上图，如果按照abc字母表的顺序创建，那么**a.com**就是这个林的林根域。
## 活动目录
活动目录(Active Directory | AD)，AD存储在DC中，是windows网络中的目录服务，存储了有关网络对象的信息，并且让管理员和用户能够轻松地查找和使用这些信息，主要提供以下功能：
* *服务器及客户端计算机管理：管理服务器及客户端计算机账户，所有服务器及客户端计算机加入域管理并实施组策略*
* *用户服务：管理用户域账户、用户信息、企业通讯录（与电子邮件系统集成）、用户组管理、用户身份认证、用户授权管理等，按省实施组管理策略*
* *资源管理：管理打印机、文件共享服务等网络资源*
* *桌面配置：系统管理员可以集中的配置各种桌面配置策略，如：用户使用域中资源权限限制、界面功能的限制、应用程序执行特征限制、网络连接限制、安全配置限制等*
* *应用系统支撑：支持财务、人事、电子邮件、企业信息门户、办公自动化、补丁管理、防病毒系统等各种应用系统*


# 0x02 准备工作

## 总览

| 物理机 | Kali Linux |
| :---: | :---: |
| **虚拟机软件** | **VirtualBox** |
| **DC** | **Windows Server 2008** |
| **DM** | **Windows 7** |

以上环境均为虚拟机环境，nat环境中实现的一个简单内网域环境
## DC
首先配置网络，不使用dhcp自动分配，手动配置，子网掩码规定内网规模，这里虚拟机nat网段**192.168.66.0/24**，规模仅为一个C段，设为**255.255.255.0**，DNS服务器的角色在域中由域控服务器充当：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/dc-network.png?raw=true)

配置好后和域成员之间相互ping一下看是否能ping通，首先在入站规则中打开icmp回显请求，不然无法ping通：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/icmp.png?raw=true)

然后添加角色：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/role-function.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/dc-role.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/role-function-latest.png?raw=true)

配置域服务，win+R输入dcpromo：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/forest.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/domainname.png?raw=true)

配置完成后重启，再次登陆用户名变为了 **domain\username** 的形式：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/win2008login.png?raw=true)

## DW
首先配置网络：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/Dmnetwork.png?raw=true)

加入test.com域：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/join-domain.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/domain-account.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/welcome-domain.png?raw=true)

重启DM，再次登陆后：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/ipconfig-all.png?raw=true)

注销当前用户，可用域控账户直接登陆到test域：

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/dm-login.png?raw=true)

![](https://github.com/c1h3ng/c1h3ng.github.io/blob/master/assets/images/dm2dc.png?raw=true)

至此一个简单的域环境就搭建好了。
